<script>
  var whitelisted = window.location.search !== '?whitelist=false';
  var app = angular.module('homeApp', []);

  app.controller('MainCtrl', function ($scope, $window, $http) {
    $scope.loginUrl = '{{{apiUrl}}}/auth/github?redirect={{{angularUrl}}}/?auth';
    $scope.data = {
      embedActive: false,
      hideUnauthorizedModal: whitelisted
    };

    if (!window.fbq) {
      // Stub fbq
      window.fbq = function () {}
    }

    // scroll to
    if (!whitelisted) {
      fbq('track', 'ViewContent', {
        action: 'notWhitelisted'
      });
      location.hash = '#sign-up-modal';
    }

    $http.get('{{{apiUrl}}}/users/me', {
      withCredentials: true
    })
      .then(function (user) {
        var org;
        try {
          org = user.data.userOptions.uiState.previousLocation.org;
        } catch (e) {
          org = user.data.accounts.github.username;
        }
        var prevInstance;
        try {
          prevInstance = user.data.userOptions.uiState.previousLocation.instance;
        } catch (e) {
        }
        var newURL = '{{{angularUrl}}}/' + org;
        if (prevInstance) {
          newURL += '/' + prevInstance
        }
        $window.location = newURL;
      });

    // start video
    var video = document.getElementsByTagName('video')[0];
    var article = document.getElementsByClassName('article-more')[0];

    if (window.location.hash === '#video') {
      startVideo();
    }

    function startVideo() {
      video.scrollIntoView({behavior: 'smooth'});
      video.classList.add('playing');
      video.play();
      pushVideo();
      window.addEventListener('resize', pushVideo);
    }

    function pauseVideo() {
      video.classList.remove('playing');
      video.pause();
      article.style.transform = null;
      window.removeEventListener('resize', pushVideo);
    }

    function pushVideo() {
      var articleOffset = video.offsetHeight - 301;
      article.style.transform = 'translate3d(0,' + articleOffset + 'px,0)';
    }

    // form submit
    function markInvalid(e) {
      var theseInputs = e.target.getElementsByTagName('input');
      for (var i = 0; i < theseInputs.length; i++) {
        if (!theseInputs[i].validity.valid) {
          theseInputs[i].classList.add('invalid');
        }
      }
    }

    function shakeForm(e) {
      var thisModal = e.target.parentElement;
      thisModal.classList.add('shake');
      thisModal.addEventListener('animationend', function(){
        thisModal.classList.remove('shake');
        thisModal.removeEventListener('animationend');
      });
    }

    function makeDirty(e){
      e.target.classList.remove('pristine', 'invalid');
    }

    function formSubmit(e){
      if (e.target.checkValidity()) {
        fbq('track', 'Lead');
      } else {
        shakeForm(e);
        markInvalid(e);
        e.preventDefault();
      }
    }

    // flipping cards
    function flipCard(e) {
      e.target.parentElement.parentElement.classList.toggle('flip');
    }

    // events
    window.onload = function(){
      // video
      var videoStart = document.getElementsByClassName('video-start');
      var videoPause = document.getElementsByClassName('video-pause');
      if (videoStart) {
        for (var i = 0; i < videoStart.length; i++) {
          videoStart[i].addEventListener('click', startVideo);
          videoStart[i].addEventListener('touchstart', startVideo);
        }
        for (var i = 0; i < videoPause.length; i++) {
          videoPause[i].addEventListener('click', pauseVideo);
          videoStart[i].addEventListener('touchstart', startVideo);
        }
      }

      //sign up form
      var formSignUp = document.getElementsByClassName('form-sign-up');
      if (formSignUp) {
        for (var i = 0; i < formSignUp.length; i++) {
          formSignUp[i].addEventListener('change', makeDirty);
          formSignUp[i].addEventListener('submit', formSubmit);
        }
      }

      // flipping cards
      var imgFlip = document.getElementsByClassName('img-rounded');
      if (imgFlip) {
        for (var i = 0; i < imgFlip.length; i++) {
          imgFlip[i].addEventListener('click', flipCard);
          imgFlip[i].addEventListener('touchstart', flipCard);
        }
      }
    };
  });
</script>